#!/usr/bin/env bash
set -euo pipefail

# Resolve symlinks so `npm link` global shims still point back to this repo.
SOURCE="${BASH_SOURCE[0]}"
while [[ -L "$SOURCE" ]]; do
  SOURCE_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
  LINK_TARGET="$(readlink "$SOURCE")"
  if [[ "$LINK_TARGET" != /* ]]; then
    SOURCE="$SOURCE_DIR/$LINK_TARGET"
  else
    SOURCE="$LINK_TARGET"
  fi
done
SCRIPT_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
CLONE_ROOT="${CLONE_ROOT:-$(cd "$SCRIPT_DIR/.." && pwd)}"
CONTROL_PLANE_SH="$CLONE_ROOT/scripts/control_plane.sh"

if [[ ! -f "$CONTROL_PLANE_SH" ]]; then
  echo "Missing control plane launcher: $CONTROL_PLANE_SH" >&2
  exit 1
fi

cmd="${1:-help}"
case "$cmd" in
  logs)
    shift || true
    exec "$CONTROL_PLANE_SH" tail "${1:-ui}"
    ;;
  precheck|start|stop|restart|status|tail|help|-h|--help)
    exec "$CONTROL_PLANE_SH" "$@"
    ;;
  *)
    cat >&2 <<EOF
Unknown command: $cmd

Usage:
  clone precheck
  clone start
  clone stop
  clone restart
  clone status
  clone logs [ui|run|events|launcher]
  clone tail [ui|run|events|launcher]
EOF
    exit 1
    ;;
esac
